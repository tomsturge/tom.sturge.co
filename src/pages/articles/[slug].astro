---
import { sanityClient } from "sanity:client";
import type { Article, WithContext } from "schema-dts";
import type { SanityImageSource } from "@sanity/image-url/lib/types/types";
import { createClient } from "@supabase/supabase-js";

import { urlForImage } from "@/sanity/urlForImage";

import { getArticle } from "@/ui/queries";
import { DefaultLayout } from "@/ui/layouts";

import { Seo, PortableText, Header, Logo, ViewCounter } from "@/ui/components";

export const getStaticPaths = async () => {
  const posts = await sanityClient.fetch(getArticle);

  return posts.map(
    ({
      _id,
      body,
      headings,
      categories,
      excerpt,
      publishedAt,
      readingTime,
      mainImage,
      socialImage,
      slug,
      title,
      author,
    }) => {
      return {
        props: {
          _id,
          body,
          headings,
          categories,
          excerpt,
          publishedAt,
          mainImage,
          socialImage,
          readingTime,
          title,
          slug,
          author,
        },
        params: { slug: slug.current },
      };
    },
  );
};

type Post = {
  _id: string;
  body: any;
  slug: {
    current: string;
  };
  headings: any;
  categories: any[];
  excerpt: string;
  mainImage: SanityImageSource;
  socialImage: SanityImageSource;
  publishedAt: Date;
  readingTime: number;
  title: string;
};

type Props = Post;

const {
  _id,
  body,
  headings,
  slug,
  categories,
  excerpt,
  mainImage,
  socialImage,
  publishedAt,
  readingTime,
  title,
} = Astro.props;

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
);

let views = 0;
try {
  const { data: viewData } = await supabase
    .from("ts_article_views")
    .select("views")
    .eq("sanity_document_id", _id)
    .single();

  views = viewData?.views || 0;
} catch (error) {
  console.warn("Could not fetch build-time view count:", error.message);
}

const schema: WithContext<Article> = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: title,
  image: urlForImage(socialImage).width(1200).height(630).url(),
  datePublished: `${publishedAt}`,
  author: [
    {
      "@type": "Person",
      name: "Tom Sturge",
      url: "https://tom.sturge.co/about",
    },
  ],
};

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<script>
  document.addEventListener("astro:page-load", () => {
    const masthead = document.querySelector(".article-masthead");

    addEventListener("scroll", (event) => {
      if (window.scrollY > 250) {
        masthead.classList.add("visible");
      } else {
        masthead.classList.remove("visible");
      }
    });
  });
</script>

<DefaultLayout title={title} type="article">
  <Fragment slot="seo">
    <Seo
      type="article"
      title={title}
      description={excerpt}
      url={canonicalURL}
      author="Tom Sturge"
      publishedAt={publishedAt}
      image={urlForImage(socialImage).width(1200).height(630).url()}
    />
    <script type="application/ld+json" set:html={JSON.stringify(schema)} />
  </Fragment>

  <div class="article-masthead">
    <div class="article-masthead__container">
      <div class="article-masthead__logo">
        <Logo />
      </div>

      <p>{title}</p>
    </div>
  </div>

  <div class="wrapper">
    <Header
      categories={categories}
      excerpt={excerpt}
      title={title}
      readingTime={readingTime}
      publishedAt={publishedAt}
      image={mainImage}
      slug={slug}
      views={views}
    />

    <div class="article-content">
      <PortableText value={body} />
    </div>
  </div>

  <!-- Hidden elements to store data for the script -->
  <div style="display: none;" data-document-id={_id} data-slug={slug}></div>
</DefaultLayout>

<script>
  import { createClient } from "@supabase/supabase-js";

  const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  );

  async function loadAndIncrementViews() {
    const documentId = document
      .querySelector("[data-document-id]")
      ?.getAttribute("data-document-id");
    const slug = document
      .querySelector("[data-slug]")
      ?.getAttribute("data-slug");
    const viewCountElement = document.getElementById("view-count");

    if (!documentId || !slug || !viewCountElement) {
      console.warn("Missing required elements for view counter", {
        documentId,
        slug,
        viewCountElement,
      });
      return;
    }

    try {
      const initialCount = parseInt(
        viewCountElement.getAttribute("data-initial") || "0",
      );

      const { data: currentData, error: fetchError } = await supabase
        .from("ts_article_views")
        .select("views")
        .eq("sanity_document_id", documentId)
        .single();

      if (!fetchError && currentData && currentData.views !== initialCount) {
        viewCountElement.textContent = currentData.views.toString();
      }

      const { error: incrementError } = await supabase.rpc("increment_view", {
        doc_id: documentId,
        article_slug: slug,
      });

      if (incrementError) {
        console.error("Error incrementing views:", incrementError);
        return;
      }
    } catch (error) {
      console.error("Failed to load/increment view count:", error);
    }
  }

  let hasIncrementedViews = false;

  const handleViewIncrement = () => {
    if (!hasIncrementedViews) {
      hasIncrementedViews = true;
      loadAndIncrementViews();
    }
  };

  // Increment views when the page loads
  document.addEventListener("DOMContentLoaded", handleViewIncrement);

  // Fallback for cases where DOMContentLoaded already fired
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", handleViewIncrement);
  } else {
    handleViewIncrement();
  }
</script>

<style lang="scss">
  .article-masthead {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    transform: translateY(-80px);
    transition: all 0.5s;
    height: 70px;
    background-color: var(--colorThemeBackgroundMain);
    box-shadow: 0 0 8px 0px rgba(0, 0, 0, 0.1);
    z-index: 100;
    display: flex;
    align-items: center;

    &.visible {
      transform: translateY(0);
    }
  }

  .article-masthead {
    &__logo {
      transform: translateY(-2px);
    }

    &__container {
      max-width: var(--widthMainContainer);
      margin: 0 auto;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      width: 100%;

      @media screen and (max-width: 79rem) {
        margin-right: 2rem;
        margin-left: 2rem;
        width: calc(100% - 4rem);
      }

      p {
        font-size: 1.15rem;
        margin: 0 0 0 1rem;
      }
    }

    @media screen and (max-width: 54rem) {
      display: none;
      visibility: hidden;
    }
  }

  .wrapper {
    max-width: var(--widthArticleContainer);
    margin: 0 auto;

    @media screen and (max-width: 81rem) {
      max-width: 43.75rem;
      margin: 0 auto;
    }

    @media screen and (max-width: 42rem) {
      margin: 0 2rem;
    }
  }

  .article-content {
    font-weight: 400;
    max-width: 45rem;
    margin: 0 auto;
  }

  .article-content__footer {
    position: relative;
    padding: 3rem 5rem;
    background-color: var(--colorBrandWhite);
  }
</style>

<style lang="scss" is:global>
  .article-content {
    color: var(--colorThemeTextMain);
    font-weight: 300;
    padding-bottom: 3rem;

    p {
      font-size: var(--fontSizeContentBody);
      font-family: var(--fontFamilyBody);
      line-height: 1.6;
      margin: 0 0 1rem;
      min-height: 1px;
    }

    .headingTwo:first-of-type {
      margin-top: 2rem !important;
    }

    ul,
    ol {
      padding-left: 3.5rem;

      @media screen and (max-width: 46.875rem) {
        padding-left: 2rem;
      }
    }

    ul {
      font-size: var(--fontSizeContentBody);
      list-style: circle;
      line-height: 1.4;

      li {
        margin-bottom: 0.5rem;
      }
    }

    ol {
      font-size: var(--fontSizeContentBody);
      line-height: 1.4;

      li {
        margin-bottom: 0.5rem;
      }
    }

    h1,
    h2,
    h3,
    h4,
    h5 {
      font-family: var(--fontFamilyHeading);
    }
  }
</style>
